<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <title>fansh::Shell</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../doc.css'/>
  <script type='text/javascript' src='../doc.js'></script>
<!--[if lt IE 7]>
<script src='http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js' type='text/javascript'></script>
<![endif]-->
</head>
<body onload='Login.check();'>
<div class='header'>
<div>
<h1><a href='/'>Fantom</a></h1>
<p id='sidewalkLogin_'>&nbsp;</p>
<form method='get' action='/sidewalk/search/'>
<p>
<input type='text' name='q' size='30' value='Search...' onfocus='if (value=="Search...") value=""' onblur='if (value=="") value="Search..."' />
</p>
</form>
<ul>
<li><a href='/'>Home</a></li>
<li class='active'><a href='../index.html'>Docs</a></li>
<li><a href='/sidewalk/blog/'>Blog</a></li>
<li><a href='/sidewalk/ticket/'>Tickets</a></li>
<li><a href='/sidewalk/topic/'>Discuss</a></li>
</ul></div>
</div>
<div class='subHeader'>
<div>
<ul>
  <li><a href='../index.html'>Doc Home</a></li>
  <li>&gt;</li>
  <li><a href='index.html'>fansh</a></li>
  <li>&gt;</li>
  <li><a href='Shell.html'>Shell</a></li>
</ul>
</div>
</div>
<div class='content'>
<div>
<div class='fandoc'>
<div class='type'>
<div class='overview'>
<h2>class</h2>
<h1>fansh::Shell</h1>
<pre><a href='../sys/Obj.html'>sys::Obj</a>
  fansh::Shell</pre>
</div>
</div>
<div class='src'>
<pre>
<span class='y'>//</span>
<span class='y'>// Copyright (c) 2008, Brian Frank and Andy Frank</span>
<span class='y'>// Licensed under the Academic Free License version 3.0</span>
<span class='y'>//</span>
<span class='y'>// History:</span>
<span class='y'>//   1 Jan 08  Brian Frank  Creation</span>
<span class='y'>//</span>

<span class='k'>using</span> compiler
<span class='k'>using</span> concurrent

<span class='z'>**</span>
<span class='z'>** Fantom Shell</span>
<span class='z'>**</span>
<span class='k'>class</span> Shell
<span class='b'>{</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Main Loop</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** Run the shell main loop.</span>
  <span class='z'>**</span>
  Void <span id='run'>run</span><span class='b'>()</span>
  <span class='b'>{</span>
    warmup
    out.printLine<span class='b'>(</span><span class='s'>"Fantom Shell v${Pod.of(this).version} ('?' for help)"</span><span class='b'>)</span>
    <span class='k'>while</span> <span class='b'>(</span>isAlive<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='y'>// input next line</span>
      out.print<span class='b'>(</span><span class='s'>"fansh&gt; "</span><span class='b'>)</span>.flush
      line := in.readLine

      <span class='y'>// quit on eof</span>
      <span class='k'>if</span> <span class='b'>(</span>line == <span class='k'>null</span><span class='b'>)</span> <span class='k'>break</span>

      <span class='y'>// skip empty lines</span>
      line = line.trim
      <span class='k'>if</span> <span class='b'>(</span>line.size == 0<span class='b'>)</span> <span class='k'>continue</span>

      <span class='y'>// check if line maps to predefined command</span>
      <span class='k'>if</span> <span class='b'>(</span>command<span class='b'>(</span>line<span class='b'>))</span> <span class='k'>continue</span>

      <span class='y'>// evaluate the line</span>
      Evaluator<span class='b'>(</span><span class='k'>this</span><span class='b'>)</span>.eval<span class='b'>(</span>line<span class='b'>)</span>
    <span class='b'>}</span>
  <span class='b'>}</span>

  <span class='k'>private</span> Void <span id='warmup'>warmup</span><span class='b'>()</span>
  <span class='b'>{</span>
    <span class='y'>// launch a dummy evaluator to preload</span>
    <span class='y'>// all the compiler code into memory</span>
    f := |-&gt;| <span class='b'>{</span> Evaluator<span class='b'>(</span><span class='k'>null</span><span class='b'>)</span>.eval<span class='b'>(</span><span class='s'>"0"</span><span class='b'>)</span> <span class='b'>}</span>
    Actor<span class='b'>(</span>ActorPool<span class='b'>()</span>, f<span class='b'>)</span>.send<span class='b'>(</span><span class='k'>null</span><span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Commands</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='z'>**</span>
  <span class='z'>** If the line maps to a command function, then run</span>
  <span class='z'>** it and return true.  Otherwise return false.</span>
  <span class='z'>**</span>
  Bool <span id='command'>command</span><span class='b'>(</span>Str line<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>switch</span> <span class='b'>(</span>line<span class='b'>)</span>
    <span class='b'>{</span>
      <span class='k'>case</span> <span class='s'>"bye"</span>:
      <span class='k'>case</span> <span class='s'>"exit"</span>:
      <span class='k'>case</span> <span class='s'>"quit"</span>:
        quit
        <span class='k'>return</span> <span class='k'>true</span>
      <span class='k'>case</span> <span class='s'>"help"</span>:
      <span class='k'>case</span> <span class='s'>"usage"</span>:
      <span class='k'>case</span> <span class='s'>"?"</span>:
        help
        <span class='k'>return</span> <span class='k'>true</span>
      <span class='k'>case</span> <span class='s'>"clear"</span>:
        clear
        <span class='k'>return</span> <span class='k'>true</span>
      <span class='k'>case</span> <span class='s'>"scope"</span>:
        dumpScope
        <span class='k'>return</span> <span class='k'>true</span>
    <span class='b'>}</span>

    <span class='k'>if</span> <span class='b'>(</span>line.startsWith<span class='b'>(</span><span class='s'>"using "</span><span class='b'>))</span>
    <span class='b'>{</span>
      addUsing<span class='b'>(</span>line<span class='b'>)</span>
      <span class='k'>return</span> <span class='k'>true</span>
    <span class='b'>}</span>

    <span class='k'>return</span> <span class='k'>false</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Run the 'quit' command.</span>
  <span class='z'>**</span>
  Void <span id='quit'>quit</span><span class='b'>()</span>
  <span class='b'>{</span>
    isAlive = <span class='k'>false</span>
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Run the 'help' command.</span>
  <span class='z'>**</span>
  Void <span id='help'>help</span><span class='b'>()</span>
  <span class='b'>{</span>
    out.printLine
    out.printLine<span class='b'>(</span><span class='s'>"Fantom Shell v${Pod.of(this).version}"</span><span class='b'>)</span>
    out.printLine<span class='b'>(</span><span class='s'>"Commands:"</span><span class='b'>)</span>
    out.printLine<span class='b'>(</span><span class='s'>"  quit, exit, bye   exit shell"</span><span class='b'>)</span>
    out.printLine<span class='b'>(</span><span class='s'>"  ?, help, usage    help summary"</span><span class='b'>)</span>
    out.printLine<span class='b'>(</span><span class='s'>"  clear             clear the using imports and local variables"</span><span class='b'>)</span>
    out.printLine<span class='b'>(</span><span class='s'>"  scope             dump the using imports and local variables"</span><span class='b'>)</span>
    out.printLine<span class='b'>(</span><span class='s'>"  using x           import pod x into namespace (any valid using stmt allowed)"</span><span class='b'>)</span>
    out.printLine
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Clear the environment</span>
  <span class='z'>**</span>
  Void <span id='clear'>clear</span><span class='b'>()</span>
  <span class='b'>{</span>
    usings.clear
    scope.clear
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Run the 'scope' command.</span>
  <span class='z'>**</span>
  Void <span id='dumpScope'>dumpScope</span><span class='b'>()</span>
  <span class='b'>{</span>
    out.printLine
    out.printLine<span class='b'>(</span><span class='s'>"Current Usings:"</span><span class='b'>)</span>
    usings.each |u| <span class='b'>{</span> out.printLine<span class='b'>(</span><span class='s'>"  $u"</span><span class='b'>)</span> <span class='b'>}</span>
    out.printLine
    out.printLine<span class='b'>(</span><span class='s'>"Current Scope:"</span><span class='b'>)</span>
    scope.vals.sort.each |v| <span class='b'>{</span> out.printLine<span class='b'>(</span><span class='s'>"  $v.of $v.name = $v.val"</span><span class='b'>)</span> <span class='b'>}</span>
    out.printLine
  <span class='b'>}</span>

  <span class='z'>**</span>
  <span class='z'>** Add using statement after we</span>
  <span class='z'>**</span>
  Void <span id='addUsing'>addUsing</span><span class='b'>(</span>Str line<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>try</span>
    <span class='b'>{</span>
      s := line<span class='b'>[</span><span class='s'>"using "</span>.size..-1<span class='b'>]</span>
      <span class='k'>if</span> <span class='b'>(</span>s.contains<span class='b'>(</span><span class='s'>" as "</span><span class='b'>))</span> s= s<span class='b'>[</span>0..&lt;s.index<span class='b'>(</span><span class='s'>" as"</span><span class='b'>)]</span>
      <span class='k'>if</span> <span class='b'>(</span>s.contains<span class='b'>(</span><span class='s'>"::"</span><span class='b'>))</span> Type.find<span class='b'>(</span>s<span class='b'>)</span>; <span class='k'>else</span> Pod.find<span class='b'>(</span>s<span class='b'>)</span>
      echo<span class='b'>(</span><span class='s'>"Add using: $line"</span><span class='b'>)</span>
      usings.add<span class='b'>(</span>line<span class='b'>)</span>
    <span class='b'>}</span>
    <span class='k'>catch</span> <span class='b'>(</span>Err e<span class='b'>)</span> echo<span class='b'>(</span><span class='s'>"  Invalid using: $e"</span><span class='b'>)</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Utils</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  <span class='k'>internal</span> Var? <span id='findInScope'>findInScope</span><span class='b'>(</span>Str name<span class='b'>)</span>
  <span class='b'>{</span>
    <span class='k'>return</span> scope.find |Var v-&gt;Bool| <span class='b'>{</span> echo<span class='b'>(</span><span class='s'>"$v ?= $name"</span><span class='b'>)</span>; <span class='k'>return</span> v.name == name <span class='b'>}</span>
  <span class='b'>}</span>

<span class='y'>//////////////////////////////////////////////////////////////////////////</span>
<span class='y'>// Fields</span>
<span class='y'>//////////////////////////////////////////////////////////////////////////</span>

  OutStream <span id='out'>out</span> := Env.cur.out
  InStream <span id='in'>in</span> := Env.cur.in
  <span class='k'>internal</span> Bool <span id='isAlive'>isAlive</span> := <span class='k'>true</span>
  <span class='k'>internal</span> Int <span id='evalCount'>evalCount</span> := 0
  <span class='k'>internal</span> Str:Var <span id='scope'>scope</span> := Str:Var<span class='b'>[</span>:<span class='b'>]</span>
  <span class='k'>internal</span> Str<span class='b'>[]</span> <span id='usings'>usings</span> := Str<span class='b'>[</span>,<span class='b'>]</span>

<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** Var</span>
<span class='z'>**************************************************************************</span>

<span class='k'>internal</span> <span class='k'>class</span> Var
<span class='b'>{</span>
  <span class='k'>override</span> Int compare<span class='b'>(</span>Obj obj<span class='b'>)</span> <span class='b'>{</span> <span class='k'>return</span> <span class='b'>((</span>Var<span class='b'>)</span>obj<span class='b'>)</span>.name &lt;=&gt; name <span class='b'>}</span>

  Type of := Obj#
  Str? name
  Obj? val
<span class='b'>}</span>

<span class='z'>**************************************************************************</span>
<span class='z'>** Main</span>
<span class='z'>**************************************************************************</span>

<span class='z'>**</span>
<span class='z'>** Main launcher for fan shell.</span>
<span class='z'>**</span>
<span class='k'>class</span> Main <span class='b'>{</span> <span class='k'>static</span> Void main<span class='b'>()</span> <span class='b'>{</span> Shell.make.run <span class='b'>}</span> <span class='b'>}</span></pre>
</div>
</div>
<div class='sidebar'>
<h2>More Info</h2>
<ul class='clean'>
  <li><a href='Shell.html'>View Fandoc</a></li>
</ul>
<div class='slots'>
<div class='overview'>
<h2>Slots</h2>
<ul class='clean'>
  <li style='display: block;'><a href='#addUsing'>addUsing</a></li>
  <li style='display: block;'><a href='#clear'>clear</a></li>
  <li style='display: block;'><a href='#command'>command</a></li>
  <li style='display: block;'><a href='#dumpScope'>dumpScope</a></li>
  <li class='hidden' style='display: block;'><a href='#evalCount'>evalCount</a></li>
  <li class='hidden' style='display: block;'><a href='#findInScope'>findInScope</a></li>
  <li style='display: block;'><a href='#help'>help</a></li>
  <li style='display: block;'><a href='#in'>in</a></li>
  <li class='hidden' style='display: block;'><a href='#isAlive'>isAlive</a></li>
  <li style='display: block;'><a href='#out'>out</a></li>
  <li style='display: block;'><a href='#quit'>quit</a></li>
  <li style='display: block;'><a href='#run'>run</a></li>
  <li class='hidden' style='display: block;'><a href='#scope'>scope</a></li>
  <li class='hidden' style='display: block;'><a href='#usings'>usings</a></li>
  <li class='hidden' style='display: block;'><a href='#warmup'>warmup</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='footer'>
<div>
<p>
fansh 1.0.56
[11-Nov-2010 Thu 10:08:20AM EST]
</p>
</div>
</div>
</body>
</html>
